/**
 * è¯»ä¹¦ç¬”è®°åˆ—è¡¨é¡µé¢ - JavaScript
 */

const state = {
  bookId: null,
  book: null,
  editingNoteId: null,
  deletingNoteId: null
};

let elements = {};

document.addEventListener('DOMContentLoaded', () => {
  // è·å– URL å‚æ•°
  const urlParams = new URLSearchParams(window.location.search);
  state.bookId = urlParams.get('bookId');

  if (!state.bookId) {
    showToast('æœªæ‰¾åˆ°ä¹¦ç±ä¿¡æ¯', 'error');
    setTimeout(() => {
      window.location.href = 'books.html';
    }, 2000);
    return;
  }

  cacheElements();
  bindEvents();
  loadBook();
});

function cacheElements() {
  elements = {
    // é¡¶éƒ¨å¯¼èˆª
    bookTitle: document.getElementById('bookTitle'),
    bookMeta: document.getElementById('bookMeta'),
    editBookBtn: document.getElementById('editBookBtn'),
    deleteBookBtn: document.getElementById('deleteBookBtn'),

    // ä¹¦ç±ä¿¡æ¯å¡ç‰‡
    bookCover: document.getElementById('bookCover'),
    bookNameDisplay: document.getElementById('bookNameDisplay'),
    authorDisplay: document.getElementById('authorDisplay'),
    ratingDisplay: document.getElementById('ratingDisplay'),
    statusDisplay: document.getElementById('statusDisplay'),
    dateDisplay: document.getElementById('dateDisplay'),
    notesCount: document.getElementById('notesCount'),

    // ç¬”è®°åˆ—è¡¨
    notesList: document.getElementById('notesList'),
    emptyState: document.getElementById('emptyState'),
    addNoteBtn: document.getElementById('addNoteBtn'),

    // æ·»åŠ /ç¼–è¾‘ç¬”è®°å¼¹çª—
    noteModal: document.getElementById('noteModal'),
    noteModalTitle: document.getElementById('noteModalTitle'),
    closeNoteModal: document.getElementById('closeNoteModal'),
    cancelNote: document.getElementById('cancelNote'),
    noteForm: document.getElementById('noteForm'),
    noteContent: document.getElementById('noteContent'),

    // åˆ é™¤ç¬”è®°å¼¹çª—
    deleteNoteModal: document.getElementById('deleteNoteModal'),
    closeDeleteNoteModal: document.getElementById('closeDeleteNoteModal'),
    cancelDeleteNote: document.getElementById('cancelDeleteNote'),
    confirmDeleteNote: document.getElementById('confirmDeleteNote'),

    // ç¼–è¾‘ä¹¦ç±å¼¹çª—
    editBookModal: document.getElementById('editBookModal'),
    closeEditBookModal: document.getElementById('closeEditBookModal'),
    cancelEditBook: document.getElementById('cancelEditBook'),
    editBookForm: document.getElementById('editBookForm'),
    editBookName: document.getElementById('editBookName'),
    editBookAuthor: document.getElementById('editBookAuthor'),
    editBookRating: document.getElementById('editBookRating'),
    editReadingStatus: document.getElementById('editReadingStatus'),
    editStartDate: document.getElementById('editStartDate'),
    editFinishDate: document.getElementById('editFinishDate'),

    // åˆ é™¤ä¹¦ç±å¼¹çª—
    deleteBookModal: document.getElementById('deleteBookModal'),
    closeDeleteBookModal: document.getElementById('closeDeleteBookModal'),
    cancelDeleteBook: document.getElementById('cancelDeleteBook'),
    confirmDeleteBook: document.getElementById('confirmDeleteBook'),
    deleteBookName: document.getElementById('deleteBookName'),

    toast: document.getElementById('toast')
  };
}

function bindEvents() {
  // ç¬”è®°ç›¸å…³
  elements.addNoteBtn?.addEventListener('click', openAddNoteModal);
  elements.closeNoteModal?.addEventListener('click', closeNoteModal);
  elements.cancelNote?.addEventListener('click', closeNoteModal);
  elements.noteModal?.addEventListener('click', (e) => {
    if (e.target === elements.noteModal) closeNoteModal();
  });
  elements.noteForm?.addEventListener('submit', handleNoteSubmit);

  // åˆ é™¤ç¬”è®°
  elements.closeDeleteNoteModal?.addEventListener('click', closeDeleteNoteModal);
  elements.cancelDeleteNote?.addEventListener('click', closeDeleteNoteModal);
  elements.deleteNoteModal?.addEventListener('click', (e) => {
    if (e.target === elements.deleteNoteModal) closeDeleteNoteModal();
  });
  elements.confirmDeleteNote?.addEventListener('click', confirmDeleteNote);

  // ç¼–è¾‘ä¹¦ç±
  elements.editBookBtn?.addEventListener('click', openEditBookModal);
  elements.closeEditBookModal?.addEventListener('click', closeEditBookModal);
  elements.cancelEditBook?.addEventListener('click', closeEditBookModal);
  elements.editBookModal?.addEventListener('click', (e) => {
    if (e.target === elements.editBookModal) closeEditBookModal();
  });
  elements.editBookForm?.addEventListener('submit', handleEditBookSubmit);

  // åˆ é™¤ä¹¦ç±
  elements.deleteBookBtn?.addEventListener('click', openDeleteBookModal);
  elements.closeDeleteBookModal?.addEventListener('click', closeDeleteBookModal);
  elements.cancelDeleteBook?.addEventListener('click', closeDeleteBookModal);
  elements.deleteBookModal?.addEventListener('click', (e) => {
    if (e.target === elements.deleteBookModal) closeDeleteBookModal();
  });
  elements.confirmDeleteBook?.addEventListener('click', confirmDeleteBook);
}

// ========== åŠ è½½æ•°æ® ==========

function loadBook() {
  const books = StorageManager.getBooks();
  state.book = books.find(b => b.id === state.bookId);

  if (!state.book) {
    showToast('ä¹¦ç±ä¸å­˜åœ¨', 'error');
    setTimeout(() => {
      window.location.href = 'books.html';
    }, 2000);
    return;
  }

  // ç¡®ä¿ç¬”è®°æ•°ç»„å­˜åœ¨
  if (!state.book.notes) {
    state.book.notes = [];
  }

  renderBookInfo();
  renderNotes();
}

// ========== æ¸²æŸ“ä¹¦ç±ä¿¡æ¯ ==========

function renderBookInfo() {
  const book = state.book;
  const stars = 'â­'.repeat(book.rating || 4);
  const statusEmoji = book.readingStatus === 'å·²è¯»' ? 'âœ…' : 'ğŸ“–';

  // é¡¶éƒ¨å¯¼èˆª
  elements.bookTitle.textContent = book.bookName;
  elements.bookMeta.textContent = `${book.author || 'æœªçŸ¥ä½œè€…'} Â· ${stars}`;

  // ä¹¦ç±ä¿¡æ¯å¡ç‰‡
  if (book.cover) {
    elements.bookCover.innerHTML = `<img src="${book.cover}" alt="${book.bookName}">`;
  } else {
    elements.bookCover.innerHTML = 'ğŸ“š';
  }

  elements.bookNameDisplay.textContent = book.bookName;
  elements.authorDisplay.textContent = book.author || 'æœªçŸ¥ä½œè€…';
  elements.ratingDisplay.textContent = stars;
  elements.statusDisplay.textContent = `${statusEmoji} ${book.readingStatus || 'åœ¨è¯»'}`;

  // æ—¥æœŸæ˜¾ç¤º
  let dateText = '';
  if (book.startDate) {
    dateText = book.finishDate
      ? `${formatDate(book.startDate)} - ${formatDate(book.finishDate)}`
      : `å¼€å§‹äº ${formatDate(book.startDate)}`;
  } else {
    dateText = 'æœªè®¾ç½®é˜…è¯»æ—¶é—´';
  }
  elements.dateDisplay.textContent = dateText;

  // ç¬”è®°æ•°é‡
  elements.notesCount.textContent = `${book.notes.length} æ¡ç¬”è®°`;
}

// ========== æ¸²æŸ“ç¬”è®°åˆ—è¡¨ ==========

function renderNotes() {
  const notes = state.book.notes || [];

  if (notes.length === 0) {
    elements.notesList.style.display = 'none';
    elements.emptyState.hidden = false;
    return;
  }

  elements.notesList.style.display = 'flex';
  elements.emptyState.hidden = true;

  // æŒ‰æ—¶é—´å€’åºæ’åˆ—
  const sortedNotes = [...notes].sort((a, b) => {
    return new Date(b.createTime) - new Date(a.createTime);
  });

  elements.notesList.innerHTML = sortedNotes.map(note => createNoteItem(note)).join('');

  // ç»‘å®šç¬”è®°äº‹ä»¶
  bindNoteEvents();
}

function createNoteItem(note) {
  const preview = getContentPreview(note.content, 150);
  const timeStr = formatDateTime(note.createTime);

  return `
    <div class="note-item" data-note-id="${note.id}">
      <div class="note-item__header">
        <span class="note-item__time">
          <i class="fas fa-clock"></i>
          ${timeStr}
        </span>
        <div class="note-item__actions">
          <button class="note-item__action-btn note-item__action-btn--edit" data-action="edit" title="ç¼–è¾‘">
            <i class="fas fa-edit"></i>
          </button>
          <button class="note-item__action-btn note-item__action-btn--delete" data-action="delete" title="åˆ é™¤">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
      <div class="note-item__content">${escapeHtml(preview)}</div>
      <div class="note-item__read-more">
        æŸ¥çœ‹è¯¦æƒ… <i class="fas fa-arrow-right"></i>
      </div>
    </div>
  `;
}

function bindNoteEvents() {
  document.querySelectorAll('.note-item').forEach(item => {
    const noteId = item.dataset.noteId;
    const editBtn = item.querySelector('[data-action="edit"]');
    const deleteBtn = item.querySelector('[data-action="delete"]');

    // ç‚¹å‡»ç¬”è®°é¡¹è¿›å…¥è¯¦æƒ…é¡µ
    item.addEventListener('click', (e) => {
      if (e.target.closest('[data-action]')) return;
      window.location.href = `note-detail.html?bookId=${state.bookId}&noteId=${noteId}`;
    });

    // ç¼–è¾‘
    editBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      openEditNoteModal(noteId);
    });

    // åˆ é™¤
    deleteBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      openDeleteNoteModal(noteId);
    });
  });
}

// ========== æ·»åŠ /ç¼–è¾‘ç¬”è®° ==========

function openAddNoteModal() {
  state.editingNoteId = null;
  elements.noteModalTitle.textContent = 'æ·»åŠ ç¬”è®°';
  elements.noteContent.value = '';
  elements.noteModal.setAttribute('aria-hidden', 'false');
  elements.noteContent.focus();
}

function openEditNoteModal(noteId) {
  state.editingNoteId = noteId;
  const note = state.book.notes.find(n => n.id === noteId);
  if (!note) return;

  elements.noteModalTitle.textContent = 'ç¼–è¾‘ç¬”è®°';
  elements.noteContent.value = note.content || '';
  elements.noteModal.setAttribute('aria-hidden', 'false');
  elements.noteContent.focus();
}

function closeNoteModal() {
  elements.noteModal.setAttribute('aria-hidden', 'true');
  elements.noteContent.value = '';
  state.editingNoteId = null;
}

function handleNoteSubmit(e) {
  e.preventDefault();

  const content = elements.noteContent.value.trim();
  if (!content) {
    showToast('è¯·è¾“å…¥ç¬”è®°å†…å®¹', 'error');
    return;
  }

  if (state.editingNoteId) {
    // ç¼–è¾‘æ¨¡å¼
    const noteIndex = state.book.notes.findIndex(n => n.id === state.editingNoteId);
    if (noteIndex !== -1) {
      state.book.notes[noteIndex].content = content;
      state.book.notes[noteIndex].updateTime = new Date().toISOString();
    }
  } else {
    // æ·»åŠ æ¨¡å¼
    const newNote = {
      id: StorageManager.generateId(),
      content: content,
      createTime: new Date().toISOString()
    };
    state.book.notes.unshift(newNote); // æ·»åŠ åˆ°å¼€å¤´
  }

  // ä¿å­˜åˆ° localStorage
  if (StorageManager.updateBook(state.bookId, state.book)) {
    showToast(state.editingNoteId ? 'ç¬”è®°æ›´æ–°æˆåŠŸ' : 'ç¬”è®°æ·»åŠ æˆåŠŸ');
    renderNotes();
    renderBookInfo(); // æ›´æ–°ç¬”è®°æ•°é‡
    closeNoteModal();
  } else {
    showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
  }
}

// ========== åˆ é™¤ç¬”è®° ==========

function openDeleteNoteModal(noteId) {
  state.deletingNoteId = noteId;
  elements.deleteNoteModal.setAttribute('aria-hidden', 'false');
}

function closeDeleteNoteModal() {
  elements.deleteNoteModal.setAttribute('aria-hidden', 'true');
  state.deletingNoteId = null;
}

function confirmDeleteNote() {
  if (!state.deletingNoteId) return;

  state.book.notes = state.book.notes.filter(n => n.id !== state.deletingNoteId);

  if (StorageManager.updateBook(state.bookId, state.book)) {
    showToast('ç¬”è®°å·²åˆ é™¤');
    renderNotes();
    renderBookInfo();
    closeDeleteNoteModal();
  } else {
    showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
  }
}

// ========== ç¼–è¾‘ä¹¦ç± ==========

function openEditBookModal() {
  const book = state.book;
  elements.editBookName.value = book.bookName || '';
  elements.editBookAuthor.value = book.author || '';
  elements.editBookRating.value = book.rating || 4;
  elements.editReadingStatus.value = book.readingStatus || 'åœ¨è¯»';
  elements.editStartDate.value = book.startDate || '';
  elements.editFinishDate.value = book.finishDate || '';
  elements.editBookModal.setAttribute('aria-hidden', 'false');
}

function closeEditBookModal() {
  elements.editBookModal.setAttribute('aria-hidden', 'true');
}

function handleEditBookSubmit(e) {
  e.preventDefault();

  const bookData = {
    bookName: elements.editBookName.value.trim(),
    author: elements.editBookAuthor.value.trim(),
    rating: parseInt(elements.editBookRating.value),
    readingStatus: elements.editReadingStatus.value,
    startDate: elements.editStartDate.value,
    finishDate: elements.editFinishDate.value
  };

  if (!bookData.bookName) {
    showToast('è¯·è¾“å…¥ä¹¦å', 'error');
    return;
  }

  if (StorageManager.updateBook(state.bookId, bookData)) {
    showToast('ä¹¦ç±ä¿¡æ¯å·²æ›´æ–°');
    loadBook();
    closeEditBookModal();
  } else {
    showToast('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
  }
}

// ========== åˆ é™¤ä¹¦ç± ==========

function openDeleteBookModal() {
  elements.deleteBookName.textContent = `ã€Š${state.book.bookName}ã€‹`;
  elements.deleteBookModal.setAttribute('aria-hidden', 'false');
}

function closeDeleteBookModal() {
  elements.deleteBookModal.setAttribute('aria-hidden', 'true');
}

function confirmDeleteBook() {
  if (StorageManager.deleteBook(state.bookId)) {
    showToast('ä¹¦ç±å·²åˆ é™¤');
    setTimeout(() => {
      window.location.href = 'books.html';
    }, 1000);
  } else {
    showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
  }
}

// ========== å·¥å…·å‡½æ•° ==========

function formatDate(dateStr) {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  return `${date.getFullYear()}.${(date.getMonth() + 1).toString().padStart(2, '0')}.${date.getDate().toString().padStart(2, '0')}`;
}

function formatDateTime(dateStr) {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  const year = date.getFullYear();
  const month = (date.getMonth() + 1).toString().padStart(2, '0');
  const day = date.getDate().toString().padStart(2, '0');
  const hours = date.getHours().toString().padStart(2, '0');
  const minutes = date.getMinutes().toString().padStart(2, '0');
  return `${year}-${month}-${day} ${hours}:${minutes}`;
}

function getContentPreview(content, maxLength) {
  if (!content) return '';
  if (content.length <= maxLength) return content;
  return content.substring(0, maxLength) + '...';
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function showToast(message, type = 'success') {
  elements.toast.textContent = message;
  elements.toast.className = `toast ${type}`;
  elements.toast.classList.add('show');

  setTimeout(() => {
    elements.toast.classList.remove('show');
  }, 3000);
}
